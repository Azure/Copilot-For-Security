![Security CoPilot Logo](https://github.com/Azure/Copilot-For-Security/blob/main/Images/ic_fluent_copilot_64_64%402x.png)
# Microsoft Security Copilot 
## Featured Capability: Generate Hunting Queries

### Introduction
**Advanced Hunting in Security Copilot **  
Security Copilot  is now enabled with purpose-built skills that leverage the generative AI capabilities of GPT-4 to reason over a natural-language prompt and generate a KQL query capable of retrieving data from Advanced Hunting tables in Microsoft Defender and top data tables in Microsoft Sentinel. See the full list of supported tables in [Appendix](#appendix).  
This new functionality replaces an earlier implementation with a vastly improved algorithm and access to the latest Azure OpenAI models. Research is underway that would extend the functionality to additional data tables in Sentinel.

### Getting Started
**Prerequisites**
1. Access to Microsoft Security Copilot 
2. Access to Defender Advanced Hunting and Microsoft Sentinel with the same credentials used to access Security Copilot .
3. Access to the necessary features and licenses in Defender and Sentinel to activate all supported tables.

**Activating the Skillset**
- Enable “Natural language to Defender 365 KQL” and “Natural language to Sentinel KQL” in the admin console under “My connections”.
- The NL2KQL skills can be automatically selected by Security Copilot  based on your prompt.
- In the prompt box, type “/kql” to select the skill explicitly before entering a prompt.

### Use Case Scenarios
You can start the investigation from an incident and ask follow-up questions:
- Tell me about incident [incidentID]
- What are the recent logon events from the user in the alert?
- Give me all the recent AAD logins from the IP address
- Did the user login from outside the US lately?
- Did the user have any alerts?
- What are the other entities associated with this user?

You can also ask questions such as:
- Show me a list of the latest URL clicks
- Find all users who have clicked on a link in the past day
- Show me recent sign-in events from [IPaddress]
- Give me the number of logons per user in the last 12 hrs by Location and sort it descending
- Is there a file in my organization with the name [file name, e.g. notepad.exe]
- Give me a list of 10 critical software vulnerabilities

### Best Practices for Writing Prompts to Generate Hunting Queries
**General guidelines** when you write prompts to generate hunting queries:
1. Be unambiguous: try to ask questions with a clear subject.
2. Ask one question at a time: ask for a single task/type of information at a time when possible.
3. Be specific: if you know anything about the data you are looking for, help provide that information in your question.
4. Use other skills: You can use Security Copilot 's other skills to help gather information that might provide useful context while writing hunting queries.

**Example guidelines:**
| Ambiguous | Good | Explanation |
| --- | --- | --- |
| Have any users logged in from suspicious locations in the last week? | Which individual accounts had suspicious or impossible travel activities in the last week? | "Suspicious locations" is subjective and might not give as consistent results. |
| Which users had the most failed login attempts in the last 72h? | Show me the 5 users with the most failed login attempts to local devices in the last 72h? | The better prompt specifies scope (5 users) and clarifies that we are looking for local device logins instead of cloud logins. |
| Network activity from suspicious Ips | Network activity from known proxy or tor-associated IP addresses | Defining what you consider suspicious is almost always better than letting the model decide. |

### Feedback
To help us improve, it is important that you share feedback with us. Please use the feedback buttons in the product to provide feedback so we can understand whether the model generated the right queries for you.
- If the query is correct and the results are as expected, please select “Confirm”.
- If the LookupDataFromDefender365Hunting skill is not being used properly, please use “Off-target” as described above.
- If the skill is run as expected but the query is incorrect, please use “Off-target”. It would be great if you provide details on why the query is incorrect and an example of the correct query.
  - **For example:**  
    **NL prompt:** Get devices with high exposure level  
    **Query generated by the model:**  
    ```
    DeviceRegistryEvents
    | where ActionType == "Create"
    | where InitiatingProcessIntegrityLevel == "High"
    | summarize count() by DeviceId, DeviceName
    ```  
    **When you share feedback, please let us know it’s off-target and share an example of the correct query as well as the failure category.**
    ```
    KQL ground truth:
    DeviceInfo
    | summarize arg_max(Timestamp, *) by DeviceId
    | where ExposureLevel == "High"
    ```  
    **Failure category:** Wrong table

### Appendix
**Supported Defender table list**  
All Defender Advanced Hunting tables are supported by NL2KQL. Please note that the AdditionalFields columns are not supported.

**Supported Sentinel table list**  
The skill might still generate KQL queries for the Sentinel tables not included in the list below. The KQL queries generated for these tables are a best-effort attempt and may come with a lower level of confidence.  
*Updated 11/10*
- AADManagedIdentitySignInLogs
- AADNonInteractiveUserSignInLogs
- AADProvisioningLogs
- AADRiskyUsers
- AADServicePrincipalSignInLogs
- AADUserRiskEvents
- ABAPAuditLog_CL
- Anomalies
- AppDependencies
- AppTraces
- AuditLogs
- AWSCloudTrail
- AWSGuardDuty
- AzureActivity
- AzureDevOpsAuditing
- AzureDiagnostics
- AzureMetrics
- BehaviorAnalytics
- CommonSecurityLog
- ContainerInventory
- ContainerLog
- DnsEvents
- Dynamics365Activity
- Event
- Heartbeat
- IdentityInfo
- InsightsMetrics
- IntuneAuditLogs
- IntuneDevices
- LAQueryLogs
- MicrosoftAzureBastionAuditLogs
- MicrosoftPurviewInformationProtection
- OfficeActivity
- Perf
- PowerBIActivity
- ProtectionStatus
- SecurityAlert
- SecurityEvent
- SecurityIncident
- SecurityRecommendation
- SigninLogs
- SqlAtpStatus
- StorageBlobLogs
- StorageFileLogs
- Syslog
- ThreatIntelligenceIndicator
- Update
- UrlClickEvents
- Usage
- UserAccessAnalytics
- UserPeerAnalytics
- VMBoundPort
- VMComputer
- VMConnection
- VMProcess
- W3CIISLog
- WindowsEvent
- WindowsFirewall
